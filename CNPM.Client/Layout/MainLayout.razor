@inherits LayoutComponentBase
@using Blazored.LocalStorage
@using System.Text.Json
@inject ILocalStorageService LocalStorage
@inject NavigationManager Nav

<div class="page">
    <nav class="custom-navbar">
        <a href="/" class="brand-logo">Home</a>

        <div class="nav-links">
            @if (!isLoggedIn)
            {
                /* --- TRƯỜNG HỢP 1: CHƯA ĐĂNG NHẬP --- */
                <NavLink class="nav-item-custom" href="login">Đăng nhập</NavLink>
                <NavLink class="nav-item-custom" href="register">Đăng ký</NavLink>
            }
            else
            {
                /* --- TRƯỜNG HỢP 2: ĐÃ ĐĂNG NHẬP --- */

                /* 1. Logic hiển thị Menu */
                if (userRole == "HubOwner")
                {
                    <NavLink class="nav-item-custom" href="register-hub">Đăng ký làm điểm nhận hàng</NavLink>
                    <NavLink class="nav-item-custom" href="order-list">Danh sách đơn hàng</NavLink>
                }
                else if (userRole == "admin")
                {
                    <NavLink class="nav-item-custom" href="duyet-diem">Duyệt điểm</NavLink>
                    <NavLink class="nav-item-custom" href="dashboard">Dashboard</NavLink>
                }
                else
                {
                    <NavLink class="nav-item-custom" href="tra-cuu">Tra cứu</NavLink>
                    <NavLink class="nav-item-custom" href="danh-sach-hub">Xem điểm nhận hàng</NavLink>
                }

                /* 2. Logic hiển thị Lời chào theo Role */
                <span class="user-greeting">
                    @if (userRole == "HubOwner")
                    {
                        <span>Chào Hub, @userName!</span>
                    }
                    else if (userRole == "admin")
                    {
                        <span>Chào ADMIN!</span>
                    }
                    else
                    {
                        <span>Chào @userName!</span>
                    }
                </span>

                <button class="btn-logout" @onclick="HandleLogout">Đăng xuất ➜</button>
            }
        </div>
    </nav>

    <main style="padding: 0;">
        @Body
    </main>
</div>

<style>
    /* CSS cũ giữ nguyên */
    .custom-navbar {
        background-color: #0f3b66;
        padding: 10px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .brand-logo {
        font-size: 1.5rem;
        font-weight: bold;
        color: white;
        text-decoration: none;
    }

    .nav-links {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .nav-item-custom {
        color: rgba(255,255,255,0.8);
        text-decoration: none;
        font-weight: 500;
        transition: color 0.2s;
    }

        .nav-item-custom:hover, .nav-item-custom.active {
            color: white;
        }

    .user-greeting {
        color: white;
        font-weight: 600;
        display: flex;
        align-items: center;
        height: 100%;
    }

    .btn-logout {
        background-color: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.5);
        padding: 6px 15px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
    }

        .btn-logout:hover {
            background-color: #ef4444;
            border-color: #ef4444;
        }
</style>

@code {
    private bool isLoggedIn = false;
    private string userRole = "";
    private string userName = "";

    protected override async Task OnInitializedAsync()
    {
        var token = await LocalStorage.GetItemAsync<string>("authToken");
        if (!string.IsNullOrEmpty(token))
        {
            isLoggedIn = true;
            ParseTokenInfo(token);
        }
    }

    private async Task HandleLogout()
    {
        await LocalStorage.RemoveItemAsync("authToken");
        isLoggedIn = false;
        userRole = "";
        userName = "";
        Nav.NavigateTo("/", forceLoad: true);
    }

    private void ParseTokenInfo(string token)
    {
        try
        {
            var parts = token.Split('.');
            if (parts.Length != 3) return;
            var payload = parts[1];
            switch (payload.Length % 4)
            {
                case 2: payload += "=="; break;
                case 3: payload += "="; break;
            }
            var jsonBytes = Convert.FromBase64String(payload);
            var keyValuePairs = JsonSerializer.Deserialize<Dictionary<string, object>>(jsonBytes);

            if (keyValuePairs.TryGetValue("role", out object r) ||
                keyValuePairs.TryGetValue("http://schemas.microsoft.com/ws/2008/06/identity/claims/role", out r))
            {
                userRole = r.ToString();
            }

            if (keyValuePairs.TryGetValue("unique_name", out object n) ||
                keyValuePairs.TryGetValue("name", out n) ||
                keyValuePairs.TryGetValue("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name", out n))
            {
                userName = n.ToString();
            }
        }
        catch { }
    }
}