@page "/order-list"
@using System.Net.Http.Json
@using CNPM.Client.Models
@using System.Net.Http.Headers
@using Blazored.LocalStorage
@using System.Text.Json
@inject ILocalStorageService LocalStorage
@inject HttpClient Http
@inject NavigationManager Nav
<div class="dashboard-container">
    <h2 class="page-title">QUẢN LÝ ĐƠN HÀNG</h2>

    <div class="toolbar-container">
        <div class="search-section">
            <input type="text"
                   class="form-control"
                   placeholder="Nhập mã vận đơn..."
                   @bind="filterRequest.OrderKeyword"
                   @bind:event="oninput" /> <button class="btn btn-primary" @onclick="LoadData">Tìm</button>
        </div>

        <div class="filter-section">
            <div class="filter-item">
                <label>Trạng thái:</label>
                <select class="form-select" @bind="filterRequest.Status">
                    <option value="all">Tất cả trạng thái</option>
                    <option value="pending">Đang chờ xử lý</option>
                    <option value="ready">Chờ lấy hàng</option>
                    <option value="pickedup">Đã lấy hàng</option>
                    <option value="cancelled">Đã hủy</option>
                </select>
            </div>

            <div class="filter-item">
                <label>Điểm nhận:</label>
                <select class="form-select" @bind="filterRequest.HubNameKeyword">
                    <option value="all">Tất cả điểm</option>
                    @if (hubOptions != null)
                    {
                        @foreach (var hub in hubOptions)
                        {
                            <option value="@hub.Name">@hub.Name</option>
                        }
                    }
                </select>
            </div>

            <button class="btn btn-primary" @onclick="LoadData">Lọc</button>
            <button class="btn btn-secondary" @onclick="ResetFilter">Đặt lại</button>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card card-orange">
            <div class="stat-icon">📦</div>
            <div class="stat-info">
                <div class="stat-label">Đang chờ xử lý</div>
                <div class="stat-sub">Pending</div>
            </div>
            <div class="stat-count">@orders.Count(x => x.Status == "pending")</div>
        </div>
        <div class="stat-card card-blue">
            <div class="stat-icon">⏳</div> <div class="stat-info">
                <div class="stat-label">Chờ lấy hàng</div>
                <div class="stat-sub">Ready</div>
            </div>
            <div class="stat-count">@orders.Count(x => x.Status == "ready")</div>
        </div>
        <div class="stat-card card-green">
            <div class="stat-icon">✅</div>
            <div class="stat-info">
                <div class="stat-label">Đã hoàn thành</div>
                <div class="stat-sub">Picked Up</div>
            </div>
            <div class="stat-count">@orders.Count(x => x.Status == "pickedup")</div>
        </div>
        <div class="stat-card card-red">
            <div class="stat-icon">❌</div>
            <div class="stat-info">
                <div class="stat-label">Đã hủy</div>
                <div class="stat-sub">Cancelled</div>
            </div>
            <div class="stat-count">@orders.Count(x => x.Status == "cancelled")</div>
        </div>
    </div>

    <div class="table-responsive">
        <table class="custom-table">
            <thead>
                <tr>
                    <th>Mã đơn</th>
                    <th>Người nhận</th>
                    <th>Trạng thái</th>
                    <th>Điểm nhận</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody>
                @if (orders != null && orders.Any())
                {
                    @foreach (var item in orders)
                    {
                        <tr>
                            <td>
                                <div class="order-code">
                                    <span class="box-icon">📦</span> #@item.Id
                                </div>
                            </td>
                            <td>
                                <div class="receiver-info">
                                    <strong>@item.ReceiverName</strong>
                                    <span>@item.ReceiverPhone</span>
                                </div>
                            </td>
                            <td>
                                <span class="badge @GetStatusBadgeClass(item.Status)">
                                    @GetStatusText(item.Status)
                                </span>
                            </td>
                            <td @onclick="() => ViewHubDetail(item.HubId)" style="cursor: pointer;" title="Xem chi tiết">
                                <div class="hub-link">
                                    <strong style="color: #1e3a8a;">@item.HubName</strong>
                                    <span class="info-icon">ℹ️</span>
                                </div>
                            </td>
                            <td>
                                <select class="action-select" @onchange="(e) => UpdateStatus(item.Id, e.Value.ToString())">
                                    <option value="pending" selected="@(item.Status == "pending")">Đang chờ xử lý</option>
                                    <option value="ready" selected="@(item.Status == "ready")">Chờ lấy hàng</option>
                                    <option value="pickedup" selected="@(item.Status == "pickedup")">Đã lấy hàng</option>
                                    <option value="cancelled" selected="@(item.Status == "cancelled")">Hủy đơn</option>
                                </select>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
    @if (showModal)
    {
        <div class="modal-backdrop" @onclick="CloseModal">
            <div class="modal-content glass-card" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <h3 class="modal-title">THÔNG TIN BƯU CỤC</h3>
                    <button class="btn-close" @onclick="CloseModal">✕</button>
                </div>

                @if (isLoadingHub)
                {
                    <p class="text-center">⏳ Đang tải thông tin...</p>
                }
                else if (selectedHub != null)
                {
                    <div class="hub-details">
                        <p>🏢 <b>Tên kho:</b> @selectedHub.Name</p>
                        <p>📍 <b>Địa chỉ:</b> @selectedHub.Address</p>
                        <p>⏰ <b>Giờ mở cửa:</b> @selectedHub.OpeningHours - @selectedHub.ClosingHours</p>

                        <div class="hub-status-row">
                            <b class="label-margin">Trạng thái:</b>
                            <span class="status-badge @GetHubStatusClass(selectedHub.Status)">
                                @GetHubStatusLabel(selectedHub.Status)
                            </span>
                        </div>
                    </div>
                }
                else
                {
                    <p class="text-center text-danger">Không tìm thấy thông tin điểm này.</p>
                }

                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseModal">Đóng</button>
                </div>
            </div>
        </div>
    }

</div>

<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr); /* Đổi từ 3 thành 4 */
        gap: 20px;
        margin-bottom: 30px;
    }

    /* Style cho Card màu đỏ */
    .card-red {
        background-color: #fff1f0;
        color: #f5222d;
        border: 1px solid #ffccc7;
    }

    /* Badge Styles Mới */
    .badge {
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        display: inline-block;
        min-width: 100px;
        text-align: center;
    }

    .badge-pending {
        background-color: #fff7e6; /* Màu cam nhạt */
        color: #d46b08;
    }

    .badge-ready {
        background-color: #e6f7ff; /* Màu xanh dương nhạt */
        color: #1890ff;
    }

    .badge-pickedup {
        background-color: #f6ffed; /* Màu xanh lá */
        color: #52c41a;
    }

    .badge-cancelled {
        background-color: #fff1f0; /* Màu đỏ */
        color: #f5222d;
    }

    .badge-default {
        background-color: #f5f5f5;
        color: #595959;
    }


    .dashboard-container {
        padding: 20px;
        font-family: 'Segoe UI', sans-serif;
        background-color: white;
        min-height: 100vh;
    }

    .page-title {
        text-align: center;
        color: #1e3a8a;
        font-weight: bold;
        margin-bottom: 25px;
        text-transform: uppercase;
    }

    /* --- TOOLBAR STYLES --- */
    .toolbar-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
    }

    .search-section {
        display: flex;
        gap: 5px;
    }

    .filter-section {
        display: flex;
        align-items: flex-end;
        gap: 10px;
    }

    .filter-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }

        .filter-item label {
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
        }

    .form-control {
        padding: 6px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        outline: none;
    }

    .form-select {
        padding: 6px 30px 6px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        outline: none;
        background-color: white;
        cursor: pointer;
    }

    .btn {
        padding: 6px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        color: white;
        transition: 0.2s;
    }

    .btn-primary {
        background-color: #2563eb;
    }

        .btn-primary:hover {
            background-color: #1d4ed8;
        }

    .btn-secondary {
        background-color: #6c757d;
    }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

    .stat-card {
        background: #fff8f8;
        padding: 15px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border: 1px solid #eee;
    }

    .stat-icon {
        font-size: 1.5rem;
        margin-right: 10px;
    }

    .stat-info {
        flex-grow: 1;
    }

    .stat-label {
        font-weight: bold;
        font-size: 0.9rem;
    }

    .stat-sub {
        font-size: 0.75rem;
        color: #888;
    }

    .stat-count {
        font-size: 1.8rem;
        font-weight: bold;
        color: #444;
    }

    .card-orange {
        background-color: #fff7e6;
        color: #d46b08;
    }

    .card-blue {
        background-color: #f0f5ff;
        color: #2f54eb;
    }

    .card-green {
        background-color: #f6ffed;
        color: #52c41a;
    }

    /* --- TABLE --- */
    .custom-table {
        width: 100%;
        border-collapse: collapse;
        border: 1px solid #eee;
    }

        .custom-table th {
            text-align: left;
            padding: 12px 15px;
            background-color: #fff;
            color: #666;
            font-weight: bold;
            border-bottom: 1px solid #eee;
        }

        .custom-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }

    .box-icon {
        color: #d46b08;
        margin-right: 5px;
    }

    .order-code {
        font-weight: bold;
        color: #2563eb;
        display: flex;
        align-items: center;
    }

    .receiver-info {
        display: flex;
        flex-direction: column;
    }

    /* Badge Styles */
    .badge {
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        display: inline-block;
        min-width: 100px;
        text-align: center;
    }

    .badge-pending {
        background-color: #fff7e6;
        color: #d46b08;
    }

    .badge-arrived {
        background-color: #f0f5ff;
        color: #2563eb;
    }

    .badge-picked {
        background-color: #f6ffed;
        color: #52c41a;
    }

    .badge-overdue {
        background-color: #fff1f0;
        color: #f5222d;
    }

    .action-select {
        padding: 5px;
        border-radius: 4px;
        border: 1px solid #ddd;
        width: 100%;
        max-width: 150px;
    }

    .pagination-controls {
        margin-top: 20px;
        display: flex;
        justify-content: flex-end;
        gap: 5px;
    }

    .btn-page {
        padding: 5px 10px;
        border: 1px solid #ddd;
        background: white;
        cursor: pointer;
    }

        .btn-page:hover {
            background: #eee;
        }

    /* CSS CHO MODAL */
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        animation: fadeIn 0.2s;
    }

    .glass-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        animation: slideUp 0.3s;
        position: relative;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }

    .modal-title {
        margin: 0;
        color: #1e3a8a;
        font-size: 1.2rem;
    }

    .btn-close {
        background: none;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        color: #888;
    }

    .hub-link {
        display: flex;
        align-items: center;
        gap: 5px;
    }

        .hub-link:hover strong {
            text-decoration: underline;
        }

    .info-icon {
        font-size: 0.8rem;
        opacity: 0.6;
    }

    .hub-details p {
        margin-bottom: 10px;
        font-size: 0.95rem;
        color: #333;
    }

    .hub-status-row {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 15px;
    }

    .modal-footer {
        text-align: right;
        margin-top: 20px;
    }

    @@keyframes fadeIn {
        from

    {
        opacity: 0;
    }

    to {
        opacity: 1;
    }

    }
    @@keyframes slideUp {
        from

    {
        transform: translateY(20px);
        opacity: 0;
    }

    to {
        transform: translateY(0);
        opacity: 1;
    }

    }

    /* Style trạng thái Hub */
    .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: bold;
    }

    .hub-active {
        background: #d1fae5;
        color: #047857;
    }

    .hub-closed {
        background: #fee2e2;
        color: #b91c1c;
    }
</style>

@code {
    private OrderFilterRequest filterRequest = new OrderFilterRequest();
    private List<OrderManagementDto> orders = new List<OrderManagementDto>();
    private List<HubOptionDto> hubOptions = new List<HubOptionDto>();
    private int totalRecords = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            var token = await LocalStorage.GetItemAsync<string>("authToken");
            if (string.IsNullOrEmpty(token)) return;

            Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);

            var queryString = $"?HubNameKeyword={filterRequest.HubNameKeyword}&Status={filterRequest.Status}&PageIndex={filterRequest.PageIndex}&PageSize={filterRequest.PageSize}";
            if (!string.IsNullOrEmpty(filterRequest.OrderKeyword))
            {
                queryString += $"&OrderKeyword={filterRequest.OrderKeyword}";
            }

            var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };

            var response = await Http.GetFromJsonAsync<PagedResult<OrderManagementDto>>(
                $"api/Order/manage-orders{queryString}",
                options
            );

            if (response != null)
            {
                orders = response.Items;
                totalRecords = response.TotalRecords;

                // Lấy danh sách HubOptions từ API để đổ vào Dropdown
                if (response.HubOptions != null && response.HubOptions.Any())
                {
                    hubOptions = response.HubOptions;
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("Lỗi: " + ex.Message);
        }
    }

    private async Task UpdateStatus(int orderId, string newStatus)
    {
        try
        {
            // 1. Tạo object request
            var payload = new
            {
                OrderId = orderId,
                NewStatus = newStatus
            };

            // 2. Gọi API
            var response = await Http.PostAsJsonAsync("api/Order/update-status", payload);

            if (response.IsSuccessStatusCode)
            {
                // Update thành công -> Load lại dữ liệu để cập nhật màu sắc/số lượng thống kê
                await LoadData();
                // Hoặc hiển thị Toast thông báo thành công
            }
            else
            {
                // Xử lý lỗi (ví dụ: in ra console hoặc hiện thông báo)
                Console.WriteLine("Lỗi cập nhật: " + await response.Content.ReadAsStringAsync());
                // Load lại data để revert cái dropdown về trạng thái cũ
                await LoadData();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("Lỗi gọi API: " + ex.Message);
        }
    }

    private async Task ResetFilter()
    {
        filterRequest = new OrderFilterRequest();
        await LoadData();
    }


    private async Task PrevPage()
    {
        if (filterRequest.PageIndex > 1) { filterRequest.PageIndex--; await LoadData(); }
    }

    private async Task NextPage()
    {
        filterRequest.PageIndex++; await LoadData();
    }

    private string GetStatusText(string status) => status?.ToLower() switch
    {
        "pending" => "🚚 Đang chờ xử lý",
        "ready" => "⏳ Chờ lấy hàng",
        "pickedup" => "✅ Đã lấy hàng",
        "cancelled" => "❌ Đã hủy",
        _ => "❓ Không rõ"
    };

    // Hàm lấy class màu sắc CSS
    private string GetStatusBadgeClass(string status) => status?.ToLower() switch
    {
        "pending" => "badge-pending",
        "ready" => "badge-ready",
        "pickedup" => "badge-pickedup",
        "cancelled" => "badge-cancelled",
        _ => "badge-default"
    };

    // 1. DTO cho chi tiết Hub (Để hiển thị trong Modal)
    public class HubDetailDto
    {
        public string Name { get; set; }
        public string Address { get; set; }
        public string OpeningHours { get; set; }
        public string ClosingHours { get; set; }
        public string Status { get; set; } // "active", "closed"
    }

    // 2. Biến điều khiển Modal
    private bool showModal = false;
    private bool isLoadingHub = false;
    private HubDetailDto selectedHub;

    // 3. Hàm mở Modal và gọi API lấy chi tiết
    private async Task ViewHubDetail(int hubId)
    {
        // 1. Reset trạng thái TRƯỚC khi hiện Modal
        selectedHub = null;
        isLoadingHub = true; // Bật loading ngay lập tức
        showModal = true;    // Sau đó mới hiện Modal

        // (Bắt buộc) Force render lại giao diện để hiện Loading ngay
        StateHasChanged();

        try
        {
            var token = await LocalStorage.GetItemAsync<string>("authToken");
            Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);

            // Gọi API
            var response = await Http.GetAsync($"api/PickupHub/{hubId}");

            if (response.IsSuccessStatusCode)
            {
                selectedHub = await response.Content.ReadFromJsonAsync<HubDetailDto>();
            }
            else
            {
                // Nếu lỗi (404, 500...), đảm bảo selectedHub là null để hiện thông báo lỗi
                selectedHub = null;
                Console.WriteLine($"API Error: {response.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            selectedHub = null;
            Console.WriteLine("Lỗi lấy thông tin kho: " + ex.Message);
        }
        finally
        {
            // 2. Tắt loading khi đã chạy xong (dù thành công hay thất bại)
            isLoadingHub = false;
        }
    }

    private void CloseModal()
    {
        showModal = false;
    }

    // 4. Helper hiển thị trạng thái Hub
    private string GetHubStatusClass(string status) => status?.ToLower() switch
    {
        "active" => "status-badge hub-active",
        _ => "status-badge hub-closed"
    };

    private string GetHubStatusLabel(string status) => status?.ToLower() switch
    {
        "active" => "Đang hoạt động",
        "closed" => "Tạm đóng",
        _ => "Không xác định"
    };
}