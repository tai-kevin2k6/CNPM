@page "/login"
@using CNPM.Client.Models
@using Blazored.LocalStorage
@inject HttpClient Http
@inject NavigationManager Nav
@inject ILocalStorageService LocalStorage

<div class="login-page-bg">
    <div class="glass-card" style="width: 100%; max-width: 600px;">
        <div class="login-icon-wrapper">
            <img src="/images/user-icon.png" alt="User Icon" class="login-icon" />
        </div>
        <h2 style="text-align:center; margin-bottom: 1.5rem; color: var(--primary-color); font-weight: 800;">ĐĂNG NHẬP</h2>

        <div style="margin-bottom: 15px;">
            <label style="font-weight:600; display:block; margin-bottom:5px;">Số điện thoại</label>
            <input @bind="loginModel.PhoneNumber" class="form-control-custom" placeholder="Nhập số điện thoại" />
        </div>

        <div style="margin-bottom: 25px;">
            <label style="font-weight:600; display:block; margin-bottom:5px; font-size: 16px;">Mật khẩu</label>
            <input type="password" @bind="loginModel.Password" class="form-control-custom" placeholder="Nhập mật khẩu" />
        </div>

        <button class="btn-primary-custom" style="width:100%" @onclick="HandleLogin">ĐĂNG NHẬP</button>

        <div style="text-align:center; margin-top:20px;">
            <a href="register" style="color: var(--secondary-color); text-decoration:none;">Chưa có tài khoản? Đăng ký ngay</a>
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div style="background:#fee2e2; color:#b91c1c; padding:10px; border-radius:8px; margin-top:15px; text-align:left; font-size:12px; overflow-wrap: break-word;">
                <b>Lỗi:</b> @errorMessage
            </div>
        }
    </div>
</div>

<style>
    /*icon*/
    .login-icon-wrapper {
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 12px;
    }

    .login-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        padding: 16px;
        background: rgba(255, 255, 255, 0.6);
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }

    .login-page-bg {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient( to bottom, #2563eb 0%, #60a5fa 40%, #ffffff 100% );
    }
</style>

@code {
    private LoginRequest loginModel = new();
    private string errorMessage;

    private async Task HandleLogin()
    {
        errorMessage = ""; // Reset lỗi cũ
        try
        {
            // 1. Gọi API
            var response = await Http.PostAsJsonAsync("api/Auth/login", loginModel);

            if (response.IsSuccessStatusCode)
            {
                // 2. Đọc kết quả
                var result = await response.Content.ReadFromJsonAsync<LoginResponse>();

                // 3. Lưu Token (Nghi ngờ lỗi ở đây nếu chưa cài LocalStorage)
                if (result != null && !string.IsNullOrEmpty(result.Token))
                {
                    await LocalStorage.SetItemAsync("authToken", result.Token);
                    // 4. Chuyển trang
                    // Thêm forceLoad: true
                    Nav.NavigateTo("/", forceLoad: true);
                }
                else
                {
                    errorMessage = "API trả về thành công nhưng không có Token!";
                }
            }
            else
            {
                errorMessage = "Đăng nhập thất bại: " + await response.Content.ReadAsStringAsync();
            }
        }
        catch (Exception ex)
        {
            // Bắt lỗi và hiện lên màn hình thay vì crash
            errorMessage = $"Lỗi hệ thống: {ex.Message} \n {ex.StackTrace}";
        }
    }
}