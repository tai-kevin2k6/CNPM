@page "/login"
@using CNPM.Client.Models
@using Blazored.LocalStorage
@inject HttpClient Http
@inject NavigationManager Nav
@inject ILocalStorageService LocalStorage

<div class="login-page-bg">
    <div class="glass-card" style="width: 100%; max-width: 400px;">
        <h2 style="text-align:center; margin-bottom: 1.5rem; color: var(--primary-color); font-weight: 800;">ĐĂNG NHẬP</h2>

        <div style="margin-bottom: 15px;">
            <label style="font-weight:600; display:block; margin-bottom:5px;">Số điện thoại</label>
            <input @bind="loginModel.PhoneNumber" class="form-control-custom" placeholder="09xxxxxx" />
        </div>

        <div style="margin-bottom: 25px;">
            <label style="font-weight:600; display:block; margin-bottom:5px;">Mật khẩu</label>
            <input type="password" @bind="loginModel.Password" class="form-control-custom" placeholder="••••••" />
        </div>

        <button class="btn-primary-custom" style="width:100%" @onclick="HandleLogin">ĐĂNG NHẬP</button>

        <div style="text-align:center; margin-top:20px;">
            <a href="register" style="color: var(--secondary-color); text-decoration:none;">Chưa có tài khoản? Đăng ký ngay</a>
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div style="background:#fee2e2; color:#b91c1c; padding:10px; border-radius:8px; margin-top:15px; text-align:left; font-size:12px; overflow-wrap: break-word;">
                <b>Lỗi:</b> @errorMessage
            </div>
        }
    </div>
</div>

<style>
    .login-page-bg {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: radial-gradient(circle at top right, #2563eb, transparent 40%), radial-gradient(circle at bottom left, #fbbf24, transparent 40%), #f3f4f6;
    }
</style>

@code {
    private LoginRequest loginModel = new();
    private string errorMessage;

    private async Task HandleLogin()
    {
        errorMessage = ""; // Reset lỗi cũ
        try
        {
            // 1. Gọi API
            var response = await Http.PostAsJsonAsync("api/Auth/login", loginModel);

            if (response.IsSuccessStatusCode)
            {
                // 2. Đọc kết quả
                var result = await response.Content.ReadFromJsonAsync<LoginResponse>();

                // 3. Lưu Token (Nghi ngờ lỗi ở đây nếu chưa cài LocalStorage)
                if (result != null && !string.IsNullOrEmpty(result.Token))
                {
                    await LocalStorage.SetItemAsync("authToken", result.Token);
                    // 4. Chuyển trang
                    // Thêm forceLoad: true
                    Nav.NavigateTo("/", forceLoad: true);
                }
                else
                {
                    errorMessage = "API trả về thành công nhưng không có Token!";
                }
            }
            else
            {
                errorMessage = "Đăng nhập thất bại: " + await response.Content.ReadAsStringAsync();
            }
        }
        catch (Exception ex)
        {
            // Bắt lỗi và hiện lên màn hình thay vì crash
            errorMessage = $"Lỗi hệ thống: {ex.Message} \n {ex.StackTrace}";
        }
    }
}