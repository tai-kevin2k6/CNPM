@page "/login"
@using CNPM.Client.Models
@using Blazored.LocalStorage
@inject HttpClient Http
@inject NavigationManager Nav
@inject ILocalStorageService LocalStorage

<div class="login-page-bg">
    <div class="glass-card login-card">
        <div class="login-icon-wrapper">
            <img src="/images/user-icon.png" alt="User Icon" class="login-icon" />
        </div>
        <h2 class="login-title">ĐĂNG NHẬP</h2>

        <div class="form-group">
            <label class="form-label">Số điện thoại</label>
            <input @bind="loginModel.PhoneNumber" class="form-control-custom" placeholder="Nhập số điện thoại" />
        </div>

        <div class="form-group-lg">
            <label class="form-label label-lg">Mật khẩu</label>
            <input type="password" @bind="loginModel.Password" class="form-control-custom" placeholder="Nhập mật khẩu" />
        </div>

        <button class="btn-primary-custom btn-full-width" @onclick="HandleLogin">ĐĂNG NHẬP</button>

        <div class="register-link-container">
            <a href="register" class="register-link">Chưa có tài khoản? Đăng ký ngay</a>
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert-error">
                <b>Lỗi:</b> @errorMessage
            </div>
        }
    </div>
</div>

<style>
    /* --- PAGE LAYOUT & BACKGROUND --- */
    .login-page-bg {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient( to bottom, #2563eb 0%, #60a5fa 40%, #ffffff 100% );
    }

    .login-card {
        width: 100%;
        max-width: 600px;
    }

    /* --- ICONS --- */
    .login-icon-wrapper {
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 12px;
    }

    .login-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        padding: 16px;
        background: rgba(255, 255, 255, 0.6);
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }

    /* --- TYPOGRAPHY --- */
    .login-title {
        text-align: center;
        margin-bottom: 1.5rem;
        color: var(--primary-color);
        font-weight: 800;
    }

    /* --- FORM ELEMENTS --- */
    .form-group {
        margin-bottom: 15px;
    }

    .form-group-lg {
        margin-bottom: 25px;
    }

    .form-label {
        font-weight: 600;
        display: block;
        margin-bottom: 5px;
    }

    .label-lg {
        font-size: 16px;
    }

    .btn-full-width {
        width: 100%;
    }

    /* --- LINKS --- */
    .register-link-container {
        text-align: center;
        margin-top: 20px;
    }

    .register-link {
        color: var(--secondary-color);
        text-decoration: none;
    }

    /* --- ALERTS --- */
    .alert-error {
        background: #fee2e2;
        color: #b91c1c;
        padding: 10px;
        border-radius: 8px;
        margin-top: 15px;
        text-align: left;
        font-size: 12px;
        overflow-wrap: break-word;
    }
</style>

@code {
    private LoginRequest loginModel = new();
    private string errorMessage;
    public class ApiErrorResponse
    {
        public bool Success { get; set; }
        public string Message { get; set; }
    }

    private async Task HandleLogin()
    {
        errorMessage = ""; // Reset lỗi cũ
        try
        {
            // 1. Gọi API
            var response = await Http.PostAsJsonAsync("api/Auth/login", loginModel);

            if (response.IsSuccessStatusCode)
            {
                // --- TRƯỜNG HỢP THÀNH CÔNG ---
                var result = await response.Content.ReadFromJsonAsync<LoginResponse>();

                if (result != null && !string.IsNullOrEmpty(result.Token))
                {
                    await LocalStorage.SetItemAsync("authToken", result.Token);
                    // Chuyển trang và reload để cập nhật trạng thái đăng nhập
                    Nav.NavigateTo("/", forceLoad: true);
                }
                else
                {
                    errorMessage = "Lỗi: Server không trả về Token.";
                }
            }
            else
            {
                // --- TRƯỜNG HỢP THẤT BẠI (400, 401...) ---
                // Đọc chuỗi JSON thô từ server (VD: {"success":false, "message":"..."})
                var errorContent = await response.Content.ReadAsStringAsync();

                try
                {
                    // Cố gắng dịch JSON sang Object C# để lấy chữ "Message"
                    var options = new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true };
                    var errorObj = System.Text.Json.JsonSerializer.Deserialize<ApiErrorResponse>(errorContent, options);

                    if (errorObj != null && !string.IsNullOrEmpty(errorObj.Message))
                    {
                        // Gán thông báo sạch đẹp
                        errorMessage = errorObj.Message;
                    }
                    else
                    {
                        // Nếu JSON không có field Message thì hiện mặc định
                        errorMessage = "Đăng nhập thất bại.";
                    }
                }
                catch
                {
                    // Nếu server trả về HTML (lỗi 500) hoặc text thường, không parse được JSON thì hiện nguyên gốc
                    errorMessage = "Lỗi: " + errorContent;
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi hệ thống: {ex.Message}";
        }
    }
}